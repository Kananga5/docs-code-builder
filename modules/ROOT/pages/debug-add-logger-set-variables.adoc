= Add Components to Your American Flights Application

include::reuse::partial$beta-banner.adoc[tag="anypoint-code-builder"] 

//LOGO (web, desktop, or both)
include::partial$acb-ide-logos.adoc[tags="both-ides"]

To facilitate debugging, add Logger and Set Variable components to the implementation in your American Flights project.

== Before You Begin

. xref:design-api-specification-from-scratch.adoc[Create the American Flights API Specification]
. xref:develop-integration.adoc##create-the-american-flights-integration-example[Create the American Flights Integration Example]
. xref:implement-api-specification.adoc[Implement the American Flights API Specification]

== Add Logger and Set Variable Components to Your Implementation

. Open the _implementaion_ file (`implementation.xml`) for your American Flights application.
. Below the Database Select operation (`<db:select/>`) named *Query Flights*, add a Set Variable component. 
. In the configuration XML, provide this `<set-variable/>` configuration:
+
[source,xml]
----
<set-variable value="#[payload]" 
     doc:name="Set variable Payload" 
     variableName="databasePayload" />
----
. Below the Set Variable component, add a Logger component with this configuration:
+
[source,xml]
----
<logger doc:name="Log Payload" message="#[
    %dw 2.0
    output application/json
    ---
    payload]" /> 
----
+
.Click for the complete implementation XML example.
[%collapsible]
====
[source,xml]
--
<flow name="getFlights">
    <logger doc:name="Logger" doc:id="ahcnzm" />
    <db:select doc:name="Query Flights" doc:id="pvuqsc" config-ref="Database_Config" >
        <db:sql>
            <![CDATA[Select * FROM american]]>
        </db:sql>
    </db:select>

    <set-variable value="#[payload]" doc:name="Set variable Payload" 
         variableName="databasePayload" doc:id="vtptsr" />  //<1>

    <ee:transform doc:name="Transform Message" doc:id="uniqueId" >
        <ee:message >
            <ee:set-payload >
                <![CDATA[
                %dw 2.0
                output application/json
                ---
                payload map ( payload01 , indexOfPayload01 ) -> {
                  ID: payload01.ID,
                  code: (payload01.code1 default "") ++ (payload01.code2 default ""),
                  price: payload01.price default 0,
                  departureDate: payload01.takeOffDate as String default "",
                  origin: payload01.fromAirport default "",
                  destination: payload01.toAirport default "",
                  emptySeats: payload01.seatsAvailable default 0,
                  plane: {
                    "type": payload01.planeType default "",
                    totalSeats: payload01.totalSeats default 0
                  }
                }
                ]]>
            </ee:set-payload>
        </ee:message>
    </ee:transform>

<logger doc:name="Log Payload" message="#[
    %dw 2.0
    output application/json
    ---
    payload]" /> //<1>

</flow>
--
[calloutlist]
.. Set Variable component
.. Logger component
====
. Proceed to <<add-breakpoint>>. 
+
Learn to set up breakpoints to pause execution of your application.

[[add-breakpoint]]
== Add Breakpoints to Your Interface

Add breakpoints to your American Flights interface:

. Open the _interface_ (`interface.xml`) for your American Flights project. 
. Select the *Run and Debug* icon in the activity bar:
+
image::run-and-debug.png[]
. On the that contains the `<flow-ref/>` component, click to add a breakpoint.
+
image::add-breakpoint.png[]
+
Alternatively, use `F9` to add a breakpoint to the line.
. Open the _implementation_ (`implementation.xml`) for your American Flights project. 
. In your implementation, add breakpoints to the `<db:select/>` and `<set-variable/>` components.
+
. Notice that all the breakpoints are now listed in the *Breakpoints* panel:
+
image::breakpoints-panel.png[]
. Proceed to xref:run-a-debug-session.adoc[]. 
+
Run a debugging session, and inspect the message and variables at different points during your application's execution.

[[debug]]
== Start a Debugging Session

. From the *Run and Debug* panel, click *Debug Mule Application*.
+
image::start-debugging.png[]
+
The IDE packages the application and opens a new terminal that deploys the application to the embedded Mule runtime engine:
+
image::packaged-and-running-terminals.png[]
. Proceed to <<test>>.

[[test]]
== Test Your Mule Application

. From a REST client or your browser, make a GET request to the running application to trigger the debugger. 
+
For guidance, see xref:ping-locally-deployed-app.adoc[].
//TODO: duke NEED TO MAKE flow-ref BREAKPOINT VISIBLE WHEN TRIGGERING APP
. In your American Flights project, notice that the execution of the application stops at your first breakpoint.
+
image::debug-stop-at-flow-ref.png[]
. Click the *Step Over* button on your debug toolbar to continue execution to next breakpoint.
. In the Debug sidebar, notice that the *Variables* panel provides information about the Mule event at the breakpoint.
+
image::debugger-stop-db-select.png[]
. Click the *Step Over* button on your debug toolbar to continue execution to your next breakpoint.
. In the Debug sidebar on the *Variables* panel, expand the *Mule Message* and the *Payload* variables and note that you can inspect the database response as an array.
+
image::debugger-stop-set-variable.png[]

== Add a Watch Expression

. Open the *Run and Debug* sidebar.
. From the *Watch* panel in the sidebar, select the `plus` icon, and add the expression `payload.^mediaType`.
+
image::debug-add-expression.png[]
. Select the *Step Over* button until your execution moves to the Set Payload component (`<set-payload/>`).
. Notice that your payload is `application/java`.
+
image:tut-debug-mediatype-java.png[]
. Select the *Step Over* button until execution continues to the Logger component (`<logger>`).
. Notice that your payload transforms to `application/json`.
+
image::tut-debug-mediatype-json.png[]
//image::debuger-watch-expression-json.png[]
. Select the *Continue* button on your debug toolbar, and notice  that the application returns the response from the database to your REST client or browser.
+
.Click for the complete implementation XML example.
[%collapsible]
====
[source,JSON]
--
[
    {
        "ID": 1,
        "code": "rree0001",
        "price": 541,
        "departureDate": "2016-01-20T00:00:00",
        "origin": "MUA",
        "destination": "LAX",
        "emptySeats": 0,
        "plane": {
            "type": "Boeing 787",
            "totalSeats": 200
        }
    },
    {
        "ID": 2,
        "code": "eefd0123",
        "price": 300,
        "departureDate": "2016-01-25T00:00:00",
        "origin": "MUA",
        "destination": "CLE",
        "emptySeats": 7,
        "plane": {
            "type": "Boeing 747",
            "totalSeats": 345
        }
    },
    {
        "ID": 3,
        "code": "ffee0192",
        "price": 300,
        "departureDate": "2016-01-20T00:00:00",
        "origin": "MUA",
        "destination": "LAX",
        "emptySeats": 0,
        "plane": {
            "type": "Boeing 777",
            "totalSeats": 300
        }
    },
    {
        "ID": 4,
        "code": "rree1000",
        "price": 200,
        "departureDate": "2016-01-20T00:00:00",
        "origin": "MUA",
        "destination": "CLE",
        "emptySeats": 5,
        "plane": {
            "type": "Boeing 737",
            "totalSeats": 150
        }
    },
    {
        "ID": 5,
        "code": "rree1093",
        "price": 142,
        "departureDate": "2016-02-11T00:00:00",
        "origin": "MUA",
        "destination": "SFO",
        "emptySeats": 1,
        "plane": {
            "type": "Boeing 737",
            "totalSeats": 150
        }
    },
    {
        "ID": 6,
        "code": "ffee1112",
        "price": 954,
        "departureDate": "2016-01-20T00:00:00",
        "origin": "MUA",
        "destination": "CLE",
        "emptySeats": 100,
        "plane": {
            "type": "Boeing 787",
            "totalSeats": 200
        }
    },
    {
        "ID": 7,
        "code": "eefd1994",
        "price": 676,
        "departureDate": "2016-01-01T00:00:00",
        "origin": "MUA",
        "destination": "SFO",
        "emptySeats": 0,
        "plane": {
            "type": "Boeing 777",
            "totalSeats": 300
        }
    },
    {
        "ID": 8,
        "code": "ffee2000",
        "price": 300,
        "departureDate": "2016-02-20T00:00:00",
        "origin": "MUA",
        "destination": "SFO",
        "emptySeats": 30,
        "plane": {
            "type": "Boeing 737",
            "totalSeats": 150
        }
    },
    {
        "ID": 9,
        "code": "eefd3000",
        "price": 900,
        "departureDate": "2016-02-01T00:00:00",
        "origin": "MUA",
        "destination": "SFO",
        "emptySeats": 0,
        "plane": {
            "type": "Boeing 737",
            "totalSeats": 150
        }
    },
    {
        "ID": 10,
        "code": "eefd4511",
        "price": 900,
        "departureDate": "2016-01-15T00:00:00",
        "origin": "MUA",
        "destination": "LAX",
        "emptySeats": 100,
        "plane": {
            "type": "Boeing 777",
            "totalSeats": 300
        }
    },
    {
        "ID": 11,
        "code": "rree4567",
        "price": 456,
        "departureDate": "2016-01-20T00:00:00",
        "origin": "MUA",
        "destination": "SFO",
        "emptySeats": 100,
        "plane": {
            "type": "Boeing 737",
            "totalSeats": 150
        }
    }
]
--
. Proceed to <<stop>>.
====

[[stop]]
== Stop the Debugging Session

To stop your debugging session: 

. Select the *Stop* button on your debug toolbar.
+
image::debugger-stop.png[]
. Proceed to xref:deploy-mule-application.adoc[Deploy a Mule Application]

