= Implementing OAS, RAML, and GraphQL API Specs
// :page-aliases: imp-implement-rest-oas-specs.adoc, imp-implement-graphql-specs.adoc


include::reuse::partial$beta-banner.adoc[tag="anypoint-code-builder"]

//LOGO (web, desktop, or both)
include::partial$acb-ide-logos.adoc[tags="both-ides"]


Use Anypoint Code Builder to implement OAS, RAML, and GraphQL API specifications.

When you implement an API spec, Anypoint Code Builder automatically scaffolds the spec into
an integration project,
creating flows for each endpoint in the spec, error handlers, and a built-in router.
You then implement the interface within the Mule app.

The process you use to implement your spec depends on whether you already created an integration project:

* To implement an API spec and create the integration project, see <<implement-api-spec>>.
* To implement an API spec in an existing project, see <<import-spec-into-project>>.

== Before You Begin

* xref:setup.adoc[Set up and access the web or desktop IDE].
* xref:des-create-api-specs.adoc[Create and test your API specification].
* xref:des-publish-api-spec-to-exchange.adoc[Publish your API specification to Exchange].
* Optionally, xref:int-create-integrations.adoc[create your integration project (Mule app)].



[[implement-api-spec]]
== Implement an API Specification

If you have not already created an integration project, use Anypoint Code Builder to
scaffold the API spec into a new Mule project:

// Open the ACB IDE
include::partial$acb-reusable-steps.adoc[tags="open-ide"]
+
image::anypoint-code-builder-view.png["Anypoint Code Builder icon highlighted in the activity bar"]
. From *Quick Actions*, click *Implement an API*.
+
image::implement-api-option-mat.png["*Implement an API* link highlighted in the *Getting Started* section"]
. Complete the *Implement an API Specification* form.
+
[%header,cols="20a,60a"] 
|===
| Field Name | Field Value

| *Project Name* | Unique name for your project.

This name is used as the title and name of the project file.
For example, if the project name is "OAS Integration", the project file name is `oas-integration`.
| *Project Location* | Your home directory or another directory you create.

See xref:start-add-folders.adoc[].

[IMPORTANT]
include::partial$acb-reusable-steps.adoc[tags="proj-directory-warn"]

| *Show filters* |See xref:filter-search-results.adoc[] for more information.
|===

. Search for an API specification on Exchange:
+
.. Start typing the name of an API specification.
.. Press Enter to display a list of possible results.
.. Click *Add Asset* to add the selected API specification:
+
image::imp-api-search.png["Search an API from Exchange"]
+
The form shows the selected API spec. 
For example:
+
image:imp-api-selected.png["OAS Example API selected in the Implement an API Specification form"]
. Click *Create Project*.

Anypoint Code Builder scaffolds your API into the new integration project and opens the project XML file.
For example:

image:imp-api-scaffolded.png["OAS Example Integration in Anypoint Code Builder"]

This example includes:

* The main flow
* An HTTP Listener with a router
* Several error handlers

For GraphQL APIs, Anypoint Code Builder also creates a data fetcher (`<graphql-router:data-fetcher>`) as a source for each Mule flow.
See the xref:tut-graphql-implement-api.adoc[] tutorial for an example GraphQL API and xref:apikit::apikit-graphql-api-mapping.adoc[] for more information about data fetchers.



[[import-spec-into-project]]
== Import an API Spec into an Implementation Project

If you have already xref:int-create-integrations.adoc[created an integration project],
you can scaffold your API specification by importing it from Exchange.
In this case, Anypoint Code Builder creates a separate configuration XML file for the interface in your integration project.

. In Anypoint Code Builder, open your integration project in the Explorer view.
For example, `my-project-name`.
// Pointer to Command Palette
include::partial$acb-reusable-steps.adoc[tags="open-command-palette"]
. Enter `import` and select the following command:
+
[source,command]
--
MuleSoft: Import Asset from Exchange
--
. Depending on the language of your API spec:
+
* *Rest API* for OAS or RAML
* *GraphQL API*
. If prompted, log in to Anypoint Platform, allowing the extension to sign in,
open an external web site, and open Visual Studio Code.
. Type the name of your API spec and press Enter.
For example, `OAS Example`.
. Wait for the IDE to load a list of matches to the name:
+
image::imp-assets-from-exchange.png["Assets from Exchange dropdown"]
. Select the API spec.
. At the prompt, select the version of the API spec to import, such as `v1.0.1`.
. When prompted to scaffold the API dependency, select *Yes*.
+
Scaffolding the API dependency:
+
** Adds the API specification as a dependency in your project's `pom.xml` file:
+
[source,XML]
--
<dependency>
    <groupId>e91cab06-650b-4634-9c6f-5bc4f4fc4d17</groupId>
    <artifactId>OAS-Example</artifactId>
    <version>1.0.1</version>
    <classifier>oas</classifier>
    <type>zip</type>
</dependency>
--
** Creates a new configuration XML file in the project, such as `oas-example.xml`:
+
image::imp-new-config-file.png["New configuration file in the Explorer view"]
+
The new configuration XML file includes the interface for your integration project,
with flows for each endpoint in the spec, error handlers, and a built-in router.
You then implement the interface within the Mule app.

// add relevant stuff from tut-implement-am-flights-api
// Then, add the logic to implement an endpoint in the API.

////


== Tour the Interface File

Examine the scaffolded flows and error handlers for your interface in the UI canvas and configuration XML.

image::scafolded-flow-canvas.png["The main flow is highlighted"]

. From the *EXPLORER* menu, open the configuration file for your interface, `american-flight-api.xml`.
. Use the *Flow List* panel to navigate through flows:
+
image::outline-list-select-flow.png["American-flights-api-main flow highlighted"]

.. Expand the *Flow List* panel.
.. Select a flow from the list.
.. Click the flow in the UI canvas to highlight the flow in the configuration XML.
. In the configuration XML, locate the flows created for the endpoints in your API specification:

* `get:\flights`
+
[source,xml]
----
<flow name="get:\flights:american-flight-api-config">
</flow>
----
* `post:\flight`
+
[source,xml]
----
<flow name="post:\flights:application\json:american-flight-api-config">
</flow>
----
* `get:\flights{ID}`
+
[source,xml,linenums]
----
<flow name="get:\flights\(ID):application\json:american-flight-api-config">
</flow>
----
. Notice the automatically generated Error Handler components. For example: 
+
//TODO: WE SHOULD SHOW HOW TO DO SOME BASIC ERROR HANDLING...
+
[source,xml]
----
<apikit:router config-ref="american-flights-api-config" />
<error-handler>
    <on-error-propagate type="APIKIT:BAD_REQUEST">

    </on-error-propagate>
    <on-error-propagate type="APIKIT:NOT_FOUND">

    </on-error-propagate>
    <on-error-propagate type="APIKIT:METHOD_NOT_ALLOWED">

    </on-error-propagate>
    <on-error-propagate type="APIKIT:NOT_ACCEPTABLE">

    </on-error-propagate>
    <on-error-propagate type="APIKIT:UNSUPPORTED_MEDIA_TYPE">

    </on-error-propagate>
    <on-error-propagate type="APIKIT:NOT_IMPLEMENTED">

    </on-error-propagate>
</error-handler>
----

[[rename]]
== Name Your Interface and Implementation Files

Provide descriptive names for the interface and implementation files in your project.

* Interface: receives all incoming requests to your application.
* Scaffolded flows in the interface: validate and route requests.
* Implementation: provides the backend logic for calls to the interface.

image::api-interface-rename.png["Rename option highlighted the context menu of american-flight-api-acb.xml file"]

. Rename `american-flight-api-acb.xml` to `interface.xml` by right-clicking the file name, selecting *Rename*, and providing the new name. 
. Rename `american-ws-anypoint-code-builder.xml` to `implementation.xml`.
. Proceed to <<endpoint>>.

[[endpoint]]
== Configure an Endpoint through the Interface 

To receive HTTP requests through the interface, remove the HTTP listener from `implementation.xml`, and in your interface file (`interface.xml`), add a Flow Ref component (`<flow-ref/>`) to the `getFlights` flow in your implementation.

. Open `implementation.xml`.
+ 
image::get-flights-select-listener.png["HTTP listener highlighted in the implementation.xml file"]
. Delete the *HTTP /flights* listener XML from the configuration XML:
+
[source,xml]
--
<http:listener path="flights" config-ref="inbound-request" doc:name="HTTP /flights" />
--
+
.Click for the resulting flow.
[%collapsible]
====
[source,xml]
--
<flow name="getFlights">
    <db:select doc:name="Query Flights" doc:id="pvuqsc" config-ref="Database_Config" >
        <db:sql>
            <![CDATA[Select * FROM american]]>
        </db:sql>
    </db:select>

    <ee:transform doc:name="Transform Message" doc:id="uniqueId" >
        <ee:message >
            <ee:set-payload >
                <![CDATA[
                %dw 2.0
                output application/json
                ---
                payload map ( payload01 , indexOfPayload01 ) -> {
                  ID: payload01.ID,
                  code: (payload01.code1 default "") ++ (payload01.code2 default ""),
                  price: payload01.price default 0,
                  departureDate: payload01.takeOffDate as String default "",
                  origin: payload01.fromAirport default "",
                  destination: payload01.toAirport default "",
                  emptySeats: payload01.seatsAvailable default 0,
                  plane: {
                    "type": payload01.planeType default "",
                    totalSeats: payload01.totalSeats default 0
                  }
                }
                ]]>
            </ee:set-payload>
        </ee:message>
    </ee:transform>

</flow>
--
====
. In Anypoint Code Builder, open your `interface.xml` file.
. Locate the `get:\flights:american-flights-api-config` flow: 
+
[source,xml]
--
<flow name="get:\flights:american-flights-api-config">
    <logger level="INFO" message="get:\flights:american-flights-api-config" />
</flow>
--
. Above the `<logger/>` element in the flow, add a Flow Reference component (`<flow-ref/>`) that references the flow `getFlights` in the implementation:
+
[source,xml]
--
<flow name="get:\flights:american-flights-api-config">
    <flow-ref doc:name="getFlightsRef" name="getFlights"/>
    <logger level="INFO" message="get:\flights:american-flights-api-config" />
</flow>
--
. Optional: Trigger a flow through your interface, and process the request with your implementation.
+
For guidance, see xref:ping-locally-deployed-app.adoc[].

////

== See Also

* xref:int-create-integrations.adoc[]
* xref:tut-graphql-implement-api.adoc[]