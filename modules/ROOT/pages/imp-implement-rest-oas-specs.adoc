= Implementing OAS and RAML  API Specifications

include::reuse::partial$beta-banner.adoc[tag="anypoint-code-builder"]

//LOGO (web, desktop, or both)
include::partial$acb-ide-logos.adoc[tags="both-ides"]


Use Anypoint Code Builder implement OAS 2.0 and 3.0 and RAML 0.8 and 1.0 API specifications.

== Before You Begin

. xref:setup.adoc[Set up and access the web or desktop IDE].
. xref:des-publish-api-spec-to-exchange.adoc[Publish your API specification to Exchange].
. xref:int-create-integrations.adoc[Create your integration (Mule app)]


== Implement an API Specification

// Open the ACB IDE
include::partial$acb-reusable-steps.adoc[tags="open-ide"]
+
image::anypoint-code-builder-view.png["Anypoint Code Builder icon highlighted in the activity bar"]
. From *Quick Actions*, click *Implement an API*.
+
image::implement-api-option-mat.png["*Implement an API* link highlighted in the *Getting Started* section"]
. Complete the *Implement an API Specification* form.
+
[%header,cols="20a,60a"] 
|===
| Field Name | Field Value

| *Project Name* | Unique name for your project.

This name is used as the title and name of the specification file.
For example, if the project name is "OAS Example", the specification file name is `oas-example`.
| *Project Location* | Your home directory or another directory you create.

See xref:work-on-home-directory.adoc[].

| *Show filters* |See xref:filter-search-results.adoc[] for more information.
|===

. In *Search Asset by name*:
+
.. Start typing the name of an API specification that is published to Exchange.
.. Press Enter to display a list of possible results.
.. Click *Add Asset* to select the API specification:
+
image::imp-api-search.png[Search an API from Exchange]

Anypoint Code Builder creates the necessary flows for each endpoint on your API specification endpoints.


== Import an API Specification into an Implementation

If you have already xref:int-create-integrations.adoc[created an integration], you can import your API specification into it:

. In Anypoint Code Builder, open your integration project in the explorer view. For example, `my-project-name`.
// Pointer to Command Palette
include::partial$acb-reusable-steps.adoc[tags="open-command-palette"]
. Enter `import` and select the following command:
+
[source,command]
--
MuleSoft: Import Asset from Exchange
--
. Select *Rest API*.
. If prompted, log in to Anypoint Platform, allowing the extension to sign in and open an external web site and to open Visual Studio Code.
. Type the name of your API specification and press Enter. For example, `OAS Example`.
. Wait for the IDE to load a list of matches to the name:
+
image::imp-assets-from-exchange.png["Assets from Exchange dropdown"]
. At the prompt, select the version of the API to import, such as `v1.0.1`.
. When prompted to scaffold the API dependency, select *Yes*.
+
This step adds the API specification as a dependency in your project's `pom.xml` file
and creates a new configuration XML file, such as `oas-example.xml`:
+
image::imp-new-config-file.png["New configuration file in the explorer view"]


// add relevant stuff from tut-implement-am-flights-api
// Then, add the logic to implement an endpoint in the API.

////

== Import and Scaffold Your API Specification

. In Anypoint Code Builder, open an integration.
For example, `my-project-name`.
// +
// For information about this application, see xref:create-basic-integration.adoc[].
. In the Command Palette, provide this command:
+
[source,command]
----
MuleSoft: Import Asset from Exchange
----
. Select *Rest API*. 
+
image::rest-api-asset-type.png["Rest API option highlighted after selecting MuleSoft: Import Asset from Exchange"]
. If prompted, log in to Anypoint Platform, allowing the extension to sign in and open an external web site and to open Visual Studio Code. 
. Type the name of your API specification. For example:
+
[source,spec name]
----
American Flights API
----
// +
// For information about this specification, see xref:design-api-specification-from-scratch.adoc[].
. Wait for the IDE to load a list of matches to the name: 
+
image::select-api-asset-from-exchange.png["American Flights API asset is highlighted"]
. When prompted for a version, select the version of the API to import, such as `_1.0.0_`.
. Select *Yes* when prompted to scaffold the API dependency.
+
This step adds the API specification as a dependency in your project's `pom.xml` file and creates a new configuration XML file, such as `american-flights-api.xml`:
+
image::scafolded-mule-config-file.png["American-flights.xml file highlighted in the package explorer section"]

== Tour the Interface File

Examine the scaffolded flows and error handlers for your interface in the UI canvas and configuration XML.

image::scafolded-flow-canvas.png["The main flow is highlighted"]

. From the *EXPLORER* menu, open the configuration file for your interface, `american-flight-api.xml`.
. Use the *Flow List* panel to navigate through flows:
+
image::outline-list-select-flow.png["American-flights-api-main flow highlighted"]

.. Expand the *Flow List* panel.
.. Select a flow from the list.
.. Click the flow in the UI canvas to highlight the flow in the configuration XML.
. In the configuration XML, locate the flows created for the endpoints in your API specification:

* `get:\flights`
+
[source,xml]
----
<flow name="get:\flights:american-flight-api-config">
</flow>
----
* `post:\flight`
+
[source,xml]
----
<flow name="post:\flights:application\json:american-flight-api-config">
</flow>
----
* `get:\flights{ID}`
+
[source,xml,linenums]
----
<flow name="get:\flights\(ID):application\json:american-flight-api-config">
</flow>
----
. Notice the automatically generated Error Handler components. For example: 
+
//TODO: WE SHOULD SHOW HOW TO DO SOME BASIC ERROR HANDLING...
+
[source,xml]
----
<apikit:router config-ref="american-flights-api-config" />
<error-handler>
    <on-error-propagate type="APIKIT:BAD_REQUEST">

    </on-error-propagate>
    <on-error-propagate type="APIKIT:NOT_FOUND">

    </on-error-propagate>
    <on-error-propagate type="APIKIT:METHOD_NOT_ALLOWED">

    </on-error-propagate>
    <on-error-propagate type="APIKIT:NOT_ACCEPTABLE">

    </on-error-propagate>
    <on-error-propagate type="APIKIT:UNSUPPORTED_MEDIA_TYPE">

    </on-error-propagate>
    <on-error-propagate type="APIKIT:NOT_IMPLEMENTED">

    </on-error-propagate>
</error-handler>
----

[[rename]]
== Name Your Interface and Implementation Files

Provide descriptive names for the interface and implementation files in your project.

* Interface: receives all incoming requests to your application.
* Scaffolded flows in the interface: validate and route requests.
* Implementation: provides the backend logic for calls to the interface.

image::api-interface-rename.png["Rename option highlighted the context menu of american-flight-api-acb.xml file"]

. Rename `american-flight-api-acb.xml` to `interface.xml` by right-clicking the file name, selecting *Rename*, and providing the new name. 
. Rename `american-ws-anypoint-code-builder.xml` to `implementation.xml`.
. Proceed to <<endpoint>>.

[[endpoint]]
== Configure an Endpoint through the Interface 

To receive HTTP requests through the interface, remove the HTTP listener from `implementation.xml`, and in your interface file (`interface.xml`), add a Flow Ref component (`<flow-ref/>`) to the `getFlights` flow in your implementation.

. Open `implementation.xml`.
+ 
image::get-flights-select-listener.png["HTTP listener highlighted in the implementation.xml file"]
. Delete the *HTTP /flights* listener XML from the configuration XML:
+
[source,xml]
--
<http:listener path="flights" config-ref="inbound-request" doc:name="HTTP /flights" />
--
+
.Click for the resulting flow.
[%collapsible]
====
[source,xml]
--
<flow name="getFlights">
    <db:select doc:name="Query Flights" doc:id="pvuqsc" config-ref="Database_Config" >
        <db:sql>
            <![CDATA[Select * FROM american]]>
        </db:sql>
    </db:select>

    <ee:transform doc:name="Transform Message" doc:id="uniqueId" >
        <ee:message >
            <ee:set-payload >
                <![CDATA[
                %dw 2.0
                output application/json
                ---
                payload map ( payload01 , indexOfPayload01 ) -> {
                  ID: payload01.ID,
                  code: (payload01.code1 default "") ++ (payload01.code2 default ""),
                  price: payload01.price default 0,
                  departureDate: payload01.takeOffDate as String default "",
                  origin: payload01.fromAirport default "",
                  destination: payload01.toAirport default "",
                  emptySeats: payload01.seatsAvailable default 0,
                  plane: {
                    "type": payload01.planeType default "",
                    totalSeats: payload01.totalSeats default 0
                  }
                }
                ]]>
            </ee:set-payload>
        </ee:message>
    </ee:transform>

</flow>
--
====
. In Anypoint Code Builder, open your `interface.xml` file.
. Locate the `get:\flights:american-flights-api-config` flow: 
+
[source,xml]
--
<flow name="get:\flights:american-flights-api-config">
    <logger level="INFO" message="get:\flights:american-flights-api-config" />
</flow>
--
. Above the `<logger/>` element in the flow, add a Flow Reference component (`<flow-ref/>`) that references the flow `getFlights` in the implementation:
+
[source,xml]
--
<flow name="get:\flights:american-flights-api-config">
    <flow-ref doc:name="getFlightsRef" name="getFlights"/>
    <logger level="INFO" message="get:\flights:american-flights-api-config" />
</flow>
--
. Optional: Trigger a flow through your interface, and process the request with your implementation.
+
For guidance, see xref:ping-locally-deployed-app.adoc[].

////

== See Also

* xref:int-create-integrations.adoc[]