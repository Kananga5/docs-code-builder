= Implement the American Flights API Specification
:page-aliases: help-overview-implement.adoc, implement-an-api-specification.adoc

include::reuse::partial$beta-banner.adoc[tag="anypoint-code-builder"] 

//LOGO (web, desktop, or both)
include::partial$acb-ide-logos.adoc[tags="both-ides"]

Anypoint Code Builder supports implementations of OAS or RAML API specifications. You can import specifications from Anypoint Exchange or use a multi-root workspace in the IDE to import without first publishing the specification to Exchange. 
//TODO: POINT TO MORE INFO 

== Before You Begin

. xref:design-api-specification.adoc[]: Complete all tasks from creating to publishing the specification to Anypoint Exchange. 
. xref:develop-integration.adoc[]: Complete all tasks from creating user snippets to transforming response data with DataWeave.

== Import the American Flights API Specification

Before implementing the American Flights API, import the specification from exhange. Add the API specification as a dependency to your `american-ws-anypoint-code-builder` project, scaffold the specification, and create a Mule application that adds the logic for each endpoint.

. In Anypoint Code Builder, open `american-ws-anypoint-code-builder.xml`.
. Open the Command Palette by pressing Ctrl+Shift+p (Windows) or Cmd+Shift+p (Mac), and provide this command:
+
[source,command]
----
MuleSoft: Import Asset from Exchange
----
+
image::import-asset-exchange-implementation.png["Rest API option highlighted after selecting MuleSoft: Import Asset from Exchange"]
// TODO: New screenshot needed? 
// More options available now: "Rest API", "DataWeave Library", "GraphQL API", and "Connector".
. Select *Rest API*. 
+
image::rest-api-asset-type.png["Rest API option highlighted after selecting MuleSoft: Import Asset from Exchange"]
. If prompted, log in to Anypoint Platform by allowing the extension to sign in, opening an external web site, and opening Visual Studio Code. 
. Type the name of your API specification. For example:
+
[source,spec name]
----
American Flights API
----
+
Wait for the IDE to load a list of matches to the name: 
+
image::select-api-asset-from-exchange.png["American Flights API asset is highlighted"]
. If prompted for a version, select the version of the API to import, such as `_1.0.0_`.
. Select *Yes* when prompted to scaffold the API dependency.
+
image::scaffold-option-yes.png["Yes option highlighted when requesting scaffolding the API dependency"]
+
This step adds the API specification as a dependency in your project's `pom.xml` file and creates a new configuration XML file, such as `american-flights-api.xml`:
+
image::scafolded-mule-config-file.png["American-flights.xml file highlighted in the package explorer section"]

== Examine the Scaffolded XML File

Display the scaffolded flow UIs from the *Flow List*, highlight a selected flows in the configuration XML, and examine the Error Handler components.

image::scafolded-flow-canvas.png["The main flow is highlighted"]

. From the *EXPLORER*, open `american-flight-api.xml`.

. Locate the flows created for these endpoints:

* `get:\flights`
+
[source,xml]
----
<flow name="get:\flights:american-flight-api-config">
</flow>
----
* `post:\flight`
+
[source,xml]
----
<flow name="post:\flights:application\json:american-flight-api-config">
</flow>
----
* `get:\flights{ID}`
+
[source,xml,linenums]
----
<flow name="get:\flights\(ID):application\json:american-flight-api-config">
</flow>
----
. Use the *Flow List* panel to navigate through flows:
.. Expand the *Flow List* panel.
+
image::outline-list-location.png["Flow list panel highlighted"]
.. Select a flow from the list.
+
image::outline-list-select-flow.png["American-flights-api-main flow highlighted"]
// TODO: Fix screenshot. Can't see the flows.
.. Click the a flow in the UI canvas to highlight the XML for the flow in the configuration XML.
. Notice the automatically generated Error Handler components in the ` <flow name="american-flight-api-main/>` element:
+
[source,xml]
--
<apikit:router config-ref="american-flights-api-config" />
<error-handler>
    <on-error-propagate type="APIKIT:BAD_REQUEST">

    </on-error-propagate>
    <on-error-propagate type="APIKIT:NOT_FOUND">

    </on-error-propagate>
    <on-error-propagate type="APIKIT:METHOD_NOT_ALLOWED">

    </on-error-propagate>
    <on-error-propagate type="APIKIT:NOT_ACCEPTABLE">

    </on-error-propagate>
    <on-error-propagate type="APIKIT:UNSUPPORTED_MEDIA_TYPE">

    </on-error-propagate>
    <on-error-propagate type="APIKIT:NOT_IMPLEMENTED">

    </on-error-propagate>
</error-handler>
--
. Proceed to <<rename>>.

[[rename]]
== Identify the Interface and Implementation Files

Provide descriptive names for the interface and implmentation files for your American Flights application. The interface will receive all incoming requests to your application. The scaffolded flows in the interface validate and route requests. The implementation will provide the backend logic for calls to the interface.

image::api-interface-rename.png["Rename option highlighted the context menu of american-flight-api-acb.xml file"]

. Rename `american-flight-api-acb.xml` to `interface.xml` by right-clicking the file name, selecting *Rename*, and providing the new name. 
. Rename `american-ws-anypoint-code-builder.xml` to `implementation.xml`.
. Proceed to <<endpoint>>.

[[endpoint]]
== Configure an Endpoint through the Interface 

To receive HTTP requests through the interface, remove the HTTP listener from `implementation.xml`, and rename the HTTP listener in `interface.xml` to `getFlights`.

. Open `implementation.xml`.
+ 
image::get-flights-select-listener.png["HTTP listener highlighted in the implementation.xml file"]
. Delete the *HTTP /flights* listener XML from the configuration XML:
+
[source,xml]
--
<http:listener path="flights" config-ref="inbound-request" doc:name="HTTP /flights" />
--
+
.Click for the resulting flow.
[%collapsible]
====
[source,xml]
--
<flow name="getFlights">
    <db:select doc:name="Query Flights" doc:id="pvuqsc" config-ref="Database_Config" >
        <db:sql>
            <![CDATA[Select * FROM american]]>
        </db:sql>
    </db:select>

    <ee:transform doc:name="Transform Message" doc:id="uniqueId" >
        <ee:message >
            <ee:set-payload >
                <![CDATA[
                %dw 2.0
                output application/json
                ---
                payload map ( payload01 , indexOfPayload01 ) -> {
                  ID: payload01.ID,
                  code: (payload01.code1 default "") ++ (payload01.code2 default ""),
                  price: payload01.price default 0,
                  departureDate: payload01.takeOffDate as String default "",
                  origin: payload01.fromAirport default "",
                  destination: payload01.toAirport default "",
                  emptySeats: payload01.seatsAvailable default 0,
                  plane: {
                    "type": payload01.planeType default "",
                    totalSeats: payload01.totalSeats default 0
                  }
                }
                ]]>
            </ee:set-payload>
        </ee:message>
    </ee:transform>

</flow>
--
====
. In Anypoint Code Builder, open your `interface.xml` file.
. Locate the `get:\flights:american-flights-api-config` flow: 
+
[source,xml]
--
<flow name="get:\flights:american-flights-api-config">
    <logger level="INFO" message="get:\flights:american-flights-api-config" />
</flow>
--
. Change the name of this flow to `getFlights`:
+
[source,xml]
--
<flow name="getFlights">
    <logger level="INFO" message="get:\flights:american-flights-api-config" />
</flow>
--

== Next Step

xref:debug-a-mule-application.adoc[Debug a Mule Application]
