= Define and Secure Properties for a Mule Application

include::reuse::partial$beta-banner.adoc[tag="anypoint-code-builder"]

Create properties that enable you to:

* Encrypt sensitive values used in your Mule application.

* Select different property files for a specific deployment environment, such as  development, sandbox, or production. 

[[get-familiar]]
== Get Familiar With Configuration Properties and Encryption

Before following step-by-step procedures for encrypting the properties or deploying applications that use the properties, learn the basics: 

* <<properties>>
* <<encryption-tool>>
* <<prop-file>>

//H3 section: properties 
//some tasks link to additional guidance with the properties
[[properties]]
=== Configuration Properties in a Mule Application

Connectors and components in the Mule configuration XML accept variables for sensitive and non-sensitive data. The variables are defined in a `.yaml` or Spring-formatted `.properties` file that you create and store in the `src/main/resources` directory of the project for your Mule application. For example:

[%header,cols="1a,1a"]
|===
| Unencrypted Values of `uname` and `pw` Keys
| Encrypted Values of `uname` and `pw` Keys

| 
[source,yaml]
----
ftp:
  workingDir: /Users/me/myworkingdir
  host: localhost
  uname: myusername
  pw: mypassword
env: dev
----
|
[source,yaml]
----
ftp:
  workingDir: /Users/me/myworkingdir
  host: localhost
  uname: UqoJI2fvggE=
  pw: n2LDIOKKxhQ5Tdv5AeCtFQ==
env: dev
----
|===

Property values in the XML configuration of a Mule application require the following syntax:

* `${property-key}` for unencrypted values
* `${secure::property-key}` for encrypted values

This FTP example specifies _encrypted_ values for its `username` and `password` attributes:

[source,xml]
----
<ftp:config name="FTP_Config" doc:name="FTP Config" doc:id="abcdefg" >
  <ftp:connection workingDir="${ftp.workingDir}" host="${ftp.host}"
    port="21" username="${secure::ftp.uname}" password="${secure::ftp.pw}" />
</ftp:config>
---- 

`ftp.uname` and `ftp.pw` reference the value of the properties through their keys.

For step-by-step instructions, see <<encrypt>>. For information about the encryption tool, see <<encryption-tool>>. 

//H3 section: encryption  
//some tasks link to additional guidance with the encryption
[[encryption-tool]]
=== Encryption with the MuleSoft Secure Properties Tool

Use MuleSoft Secure Properties Tool (`secure-properties-tool.jar`) to encrypt sensitive data. 

The following examples use the Blowfish algorithm to encrypt two strings (`"myusername"` and `"mypassword"`), provide the same encryption key _value_ (`my-key`) as a password for the encryption key, and use the default encryption mode, CBC. 

* This example encrypts `"myusername"` as `dlwfnITNF2aBCLn588sgFA==`:
+
[source,terminal]
----
$ java -cp secure-properties-tool.jar com.mulesoft.tools.SecurePropertiesTool \
> string \
> encrypt \
> Blowfish \
> CBC \
> my-key \
> "myusername"
dlwfnITNF2aBCLn588sgFA==
----

* This example encrypts `"mypassword"` as `n2LDIOKKxhQ5Tdv5AeCtFQ==`:
+
[source,terminal]
----
$ java -cp secure-properties-tool.jar com.mulesoft.tools.SecurePropertiesTool \
> string \
> encrypt \
> Blowfish \
> CBC \
> my-key \
> "mypassword"
n2LDIOKKxhQ5Tdv5AeCtFQ==
----

[[algorithms]]
MuleSoft Secure Properties Tool and the Secure Properties element (`<<secure-properties/>`) accept the following algorithms:

* AES 
* Blowfish
* DES
* DESede
* RC2
* RCA

[[ciphers]]
//This comes from Mule Runtime docs. Not verified in ACB yet by me:
MuleSoft Secure Properties Tool and the Secure Properties element (`<<secure-properties/>`) accept the following ciphers:

* CBC (default)
* CFB
* ECB
* OFB

For step-by-step instructions on encrypting properties in a Mule application, see <<encrypt>>. 

[[prop-file]]
=== Property Files for Different Deployment Targets

Hosts, ports, directories, and other settings in the configuration XML often differ depending on the target environment for your deployment, such as the development, sandbox, or production environment. For example, on your desktop, the host name is typically `localhost`, the port something like `8081`, and the directory is a path on your local machine rather than a path to an external host.

When developing your application in the IDE, create separate properties files for each of the target environment that requires different settings, and provide the  appropriate settings in each file. 

[[filename-patterns]]
Typical filenames follow patterns like these:

* `dev.properties.yaml` or `dev.secure.yaml` for your development environment in the IDE
* `sandbox.properties.yaml` or `sandbox.secure.yaml` for a pre-production environment
* `prod.properties.yaml` or `sandbox.secure.yaml` for the production environment

Consistent filename patterns enable you to use an `$\{env}` variable in your configuration XML for the prefix to the filename, for example, `$\{env}.properties.yaml` or `$\{env}.secure.yaml`. 

[[prefix]]
Notice the value of the `file` attribute in this example:

[source,xml]
----
<secure-properties:config name="Secure_Properties_Config" 
  doc:name="Secure Properties Config" doc:id="acegik" 
  file="${env}.secure.yaml" key="${encryption.key}" >
      <secure-properties:encrypt algorithm="Blowfish" />
</secure-properties:config>
----

For step-by-step instructions on using the `env` variable, see <<create-prop-file>>.

//H2 PROCEDURE: ENCRYPT
[[encrypt]]
== Encrypt Sensitive Values in a Mule Application

Use the Secure Properties Tool to encrypt sensitive data in your properties files. 

. Create a properties file with _unencrypted_ properties:
+
//TODO: ADD SCREENSHOT OF DIRECTORY AND PROPERTIES FILE
.. Open the project for your Mule application to its `src/main/resources` directory.
.. Create a YAML file with a name like `dev.properties.yaml` or `local.properties.yaml` that configures properties as key-value pairs. For example:
+
[source,yaml]
----
myprop : "somevalue"

mysensitiveprop : "somesensitivevalue"
---- 
+
For more guidance, see <<properties>>.
. Encrypt sensitive properties:
.. Download the https://docs.mulesoft.com/mule-runtime/4.4/_attachments/secure-properties-tool.jar[Secure Properties Tool], an executable JAR file for encrypting properties.
.. From the command line, run the Secure Properties Tool on the values you intend to secure.
+
.Example that encrypts `"mysensitivevalue"` using Blowfish and `my-key` for an encryption key password:
[source,terminal]
----
$ java -cp secure-properties-tool.jar com.mulesoft.tools.SecurePropertiesTool \ string \
encrypt \
Blowfish \
CBC \
my-key \
"mysensitivevalue" 
----
+
:Important: Be sure to store your encryption key value in a safe location that you can retrieve when you deploy your application. If deploy with the wrong value, the deployment will fail because it will decrypt your sensitive value. 
+
.Encrypted Output:
[source,terminal]
----
/MU0/xB/zoMPjxBA7/9X44Ad2H8O8AY5
----
+
For more information, see <<encrypt>>. 

. In your properties file, add each encrypted property value within `![]` brackets.
+
.Example that replaces the unencrypted value `"mysensitivevalue"` with the encrypted value `"![/MU0/xB/zoMPjxBA7/9X44Ad2H8O8AY5]"`:
[source,yaml]
----
myprop : "somevalue"
mysensitiveprop : "![/MU0/xB/zoMPjxBA7/9X44Ad2H8O8AY5]"
---- 
For guidance, see <<properties>>.

. Use the encrypted value in a Mule application:
+
//TODO: SCREENSHOT OF FLOW AND CONFIGURED Secure Configuration Properties snippet
.. Add the key to the encrypted property as a value of an attribute in connector or component XML. For example:
+
[source,xml]
----
<set-payload 
  value="${secure::mysensitiveprop}" 
  doc:name="Set payload" doc:id="abcdef" />
----
.. Above the `<flow/>` element in your the configuration XML, add the Secure Configuration Properties _snippet_ (`<secure-properties:config/>`) by pressing Ctrl+Space (Mac) or Cmd+Space(Windows), typing the initial letters of the element name, such as `secu`, and selecting the snippet.
+
image::acb-snippet-secure-config-prop.png["Selecting Secure Configuration Properties Snippet"]
+
The XML for an unmodified snippet looks like this above a `<flow/>` element:
+
[source,xml]
----
<secure-properties:config name="Secure_Properties_Config" 
  doc:name="Secure Properties Config" doc:id="ukvpll" 
  file="${env}.secure.yaml" key="${encryption.key}" >
      <secure-properties:encrypt algorithm="Blowfish" />
</secure-properties:config>

<flow name="some-flow" >
...
----
+
The snippet preconfigures parts of the element that the basic XML configuration does not, so be sure to select the _snippet_ and _not_ the basic XML for this element, which has the same name but a different icon. Like all snippets, this snippet is identified by a two-dimensional box icon, while the basic XML for this element has a three-dimensional box icon. 
.
.. Configure the snippet with values for the `file`, `key`, and `algorithm` attributes. For example:
+
[source,xml]
----
<secure-properties:config name="Secure_Properties_Config" 
  doc:name="Secure Properties Config" doc:id="ddzpxf" 
  file="dev.properties.yaml" key="${encryption.key}" >
   <secure-properties:encrypt algorithm="Blowfish" />
</secure-properties:config>
----
+
* `file`: Name of your properties file 
+
To use the variable `$\{env}` in your filename configuration, see <<env-variable>>.
* `name`: A name of your choice for the encryption key (defaults to `${encryption.key}`).
* `algorithm`: Algorithm you used to encrypt your secure properties (defaults to Blowfish in the snippet).
+
See <<algorithms>>.

. Test your application in the IDE:
.. Navigate to *Manage* (gear icon) > *Settings*, and find *Runtime: Default Arguments* on the *Settings* page. 
.. In the *Runtime: Default Arguments* field, add the key-value pair for your encryption key to the _end_ of the configuration. For example:
+
[source,key-configuration]
----
-M-Dencryption.key=my-key
----
+
In the example, `-M-D` is the required prefix, `encryption.key` is the default name of the encryption key, and `my-key` is the value used to encrypt the properties through the Secure Properties Tool. 
.. Deploy the application locally within the IDE by pressing Ctrl+shift+p (Windows) or CmdCtrl+shift+p (Mac), entering *View: Show Run and Debug*, and clicking *Run and Debug*.
+
A successful deployment produces the following message in the *OUTPUT* tab of the output panel. For information about the output panel, see xref:configure-default-output-panel.adoc[].
+
----
**********************************************************************
*              - - + DOMAIN + - -               * - - + STATUS + - - *
**********************************************************************
* default                                       * DEPLOYED           *
**********************************************************************
----
+
If the application does not deploy successfully, check the console for the error and troubleshoot. 
. If you intend to deploy your application to CloudHub, proceed to <<deploy-to-cloudhub>>.
+
This procedure shows you the hidden encryption key name in Runtime Manager. 

//H2 PROCEDURE: DEPLOY
[[deploy-to-cloudhub]]
== Deploy to CloudHub with Sensitive Values Hidden

Hide the value of an encryption key or other property in the Runtime Manager UI when you deploy an application to CloudHub. Runtime Manager otherwise displays that value (see xref:cloudhub-1::cloudhub-manage-props.adoc[]). 

Before you begin: 

* Run and test encrypted properties used by your Mule application in your IDE. See <<properties>> for guidance.
* Make sure that you have the required permission: *Anypoint Code Builder Developer*. See xref:configure-permissions.adoc[].
+
If you do not have the required permission, the following error occurs when you attempt to deploy to one of the CloudHub environments:
+
----
Failed to deploy to CloudHub: 403 User unauthorized to access requested resource
----

To hide sensitive values from the Runtime Manager UI when you deploy to CloudHub: 

. In the `mule-artifact.json` file for your application, provide the _name_ of the encryption key (`encryption.key` by default) that you provided in the global `<secure-properties:config/>` snippet within your configuration XML. For example:
+
----
{
    "minMuleVersion": "4.4.0",
    "secureProperties": [encryption.key, other.value.to.hide]
}
----
+
The _name_ (not the _value_) of your encryption key goes into a comma-separated `secureProperties` array. Later in this procedure, when you deploy your application to CloudHub, the IDE prompts you to provide the _value_ of the encryption key that you provided through the Secure Configuration Tool when encrypting your sensitive properties.
. Deploy your application to CloudHub by pressing Cmd+shift+p (Windows) or Ctrl+shift+p (Mac) and entering *MuleSoft: Deploy to CloudHub*.
. When prompted, enter _the same value_ you used to encrypt your secure properties.
+
If you do not enter the same value, the application is able to upload to CloudHub, but the deployment will fail because the encryption key value will not work.
. Select the *Sandbox* environment for your deployment.
+
Other environments are not supported, and attempts to deploy to the *Design* environment fail with a `500` error code. While the deployment is in progress, the IDE provides the status of the process and prompts you to open the application in Runtime Manager when the deployment completes.  
+
It is possible for an application to upload correctly but fail to complete the deployment process successfully, for example, because the provided encryption key value is invalid. The error message says that the application `was not successfully deployed to "Sandbox" in CloudHub`, but it provides a way to *Open in Runtime Manager* to check the logs and correct some issues.
. Click *Open in Runtime Manager* to open the management options for the application in Runtime Manager.
. Check the deployment in Runtime Manager to ensure that the encryption key is hidden.
+
In the *Applications* screen for the *SANDBOX* environment, check the *Status* field for your application:

* If the status is *Started*, the deployment is successful, and the application is running.
* If the status is *Deploy failed*, click the name of your application, and navigate to *Logs* to discover the cause of the failure.
+
If the encryption key value is wrong, the error is `org.mule.encryption.exception.MuleEncryptionException: Could not encrypt or decrypt the data.`
+
To fix this error:
+
. Navigate to *Settings* > *Properties* for your application in Runtime Manager. . Provide the correct value for your encryption key in the field for the encryption key.
* Click *Apply Changes*.
+
Runtime Manager apply your changes and attempt to deploy your application. 

For more information, see xref:runtime-manager::index.adoc[]. For information about CloudHub, see xref:cloudhub-1::index.adoc[].

[[create-prop-file]]
== Provide Settings for Different Environments

When developing your application, create separate properties files for each target environment (such as development, sandbox, or production) that requires different settings, and provide the appropriate settings in each file. 

The file names must follow a consistent pattern so that you can configure a variable such as `$\{env}` as a modifiable prefix that enables you to switch to the file that contains settings for the environment in which your application runs. You can include encrypted and unencrypted property values in the files.

To configure and use the `env` variable as a prefix to a filename:

. Using a consistent filename pattern, create properties files for each environment that requires different settings.
+ 
For guidance with naming and configuring the contents of properties files, review <<prop-file>>.
. If you are using the `<secure-properties/>` or another element that points to your properties file, set the value for the filename with variable for the prefix, such as `$\{env}`. For example:
+
----
file="${env}.secure.yaml"
----
+
See <<prefix, Secure Properties example>> for more detail. 
. Add a `<global-property/>` element to the configuration XML that defines the value of `env` property. 
+
[source,xml]
----
<global-property name="env" value="dev" />
----
+
After deploying to CloudHub, you can add a new value for this property through the Runtime Manager UI.
. Make sure the application deploys locally in the IDE before deploying to CloudHub:
+
.. Deploy your application to CloudHub by pressing Cmd+shift+p (Windows) or Ctrl+shift+p (Mac) and entering *MuleSoft: Deploy to CloudHub*.
.. If prompted, enter _the same value_ you used to encrypt your secure properties.
.. Select the *Sandbox* environment for your deployment.
. Once the deployment is complete, click *Open in Runtime Manager* to open the management options for the application in Runtime Manager.
. Set the `env` property for the application in Runtime Manager:
.. Click *Settings* > *Properties* tab for the application.
.. In the *Properties* tab, provide a new *env* key with the value for the environment, such as *sandbox*. 
.. Click *Apply Changes* to launch a deployment with the new setting for `env` in your application.
+
The new setting makes the application use the properties file with the prefix that matches the value you provided for *env* in Runtime Manager. This setting overrides the global property setting (`<global-property/>`) in the configuration XML for your application. 

//TODO: IS THERE ANOTHER WAY TO SET env? WHAT ABOUT FOR ON-PREM? 


== See Also

* xref:mule-runtime::secure-configuration-properties.adoc[]
