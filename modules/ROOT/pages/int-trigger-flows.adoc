= Triggering Flows in Your Development Environment
:page-deployment-options: cloud-ide, desktop-ide
:page-aliases: ping-locally-deployed-app.adoc

include::reuse::partial$beta-banner.adoc[tag="anypoint-code-builder"]

When an integration or implementation that you are developing builds successfully within the Anypoint Code Builder IDE, the application deploys within your development environment, whether on your desktop or the cloud-based host for your applications.  

It is common to configure the HTTP Listener from  xref:http-connector::index.adoc[Anypoint Connector for HTTP] (HTTP Connector) to trigger the execution of a flow in a deployed application. You can trigger the flow from the built-in terminal in Anypoint Code Builder, from a REST client, or from your browser.

[[before-you-begin]]
== Before You Begin

* Complete xref:start-acb.adoc[] for your IDE.
* Make sure an integration or implementation project with an HTTP Listener (`<http:listener/>`) is available from the cloud or desktop IDE.
+
To create a project, see xref:int-create-integrations.adoc[] or xref:imp-implementing-apis.adoc[], or follow the procedures in the tutorial xref:tut-af-amflights-overview.adoc[].

== Integrations Versus Implementations

An important difference between integration and implementation projects is that the interface for implementations is typically generated through an automated scaffolding process that generates an HTTP Listener for triggering a flow in your application, as indicated in the American Flights tutorial, in xref:tut-af-implement-am-flights-api.adoc#endpoint[Configure an Endpoint through the Interface]. 

The URL to use for triggering the HTTP Listener in a scaffolded interface generated from an API specification differs slightly from an integration project that does not implement a scaffolded interface: 

* Desktop IDE example for an integration project _without_ a scaffolded interface to trigger a locally deployed endpoint: 
+
----
http://localhost:8081/some-endpoint
----
+
Notice the configuration in the `<http:listener-connection/>` element:
+
[source,xml]
----
<http:listener-config name="inbound-request" 
      doc:name="Listener Config" doc:id="b5c62f">
  <http:listener-connection host="0.0.0.0" port="8081"/>
</http:listener-config>
<flow name="getFlights">
    <http:listener path="flights" config-ref="inbound-request" doc:name="HTTP /flights" />
    ...
</flow>
----
* Desktop IDE example for an implementation or integration project _with_ a scaffolded interface to trigger a locally deployed endpoint: 
+
----
http://localhost:8081/api/some-endpoint
----
+
Notice that the URL adds `api/` to the URL to make the request trigger the `<http:listener/>`. This listener is located before the router (`<apikit:router/>`) in the scaffolded interface within the configuration XML. Notice the automatically set attribute `path="/api/*"` in the listener's XML:
+
[source,xml]
----
<apikit:config name="american-flight-api-config" 
               api="resource::bc64acc7-41ad-43b7-9e0a-092182b03271:American-Flight-API:1.0.0:raml:zip:american-flight-api.raml" 
               outboundHeadersMapName="outboundHeaders"  
               httpStatusVarName="httpStatus" />
<flow name="american-flight-api-main">
    <http:listener config-ref="inbound-request" path="/api/*">
        <http:response statusCode="#[vars.httpStatus default 200]">
            <http:headers>#[vars.outboundHeaders default {}]</http:headers>
        </http:response>
        <http:error-response statusCode="#[vars.httpStatus default 500]">
            <http:body>#[payload]</http:body>
            <http:headers>#[vars.outboundHeaders default {}]</http:headers>
        </http:error-response>
    </http:listener>
    <apikit:router config-ref="american-flight-api-config" />
    ...
</flow>
----

Both sets of examples configure the host for the HTTP Listener connection to `0.0.0.0` and the port to `8081` because local deployments within the IDE typically uses these settings or a similar port, such as `8082`, if `8081` is currently in use by another application.

////
Another difference the desktop and cloud IDEs differ for deployments to your development environment in Anypoint Code Builder:

* In the desktop IDE, a URI configured for the listener, such as `+http://localhost:8081/some-endpoint+`, works if no other applications are using that port. 
+
Add `/api` to the URI for a listener in a scaffolded interface that you generate when implementing an API specification in the IDE, for example:
`+http://localhost:8081/api/some-endpoint+`.

* In the cloud IDE, your development environment is hosted remotely, so you must configure a URL to a proxy for your application's host. 
+
For guidance constructing the URL in the cloud IDE, see:

** <<ping-browser>> 
** <<ping-rest-client>>
////

== Trigger Locally Deployed Apps in Cloud IDEs and Desktop IDEs

After meeting the prerequisites in <<before-you-begin>>, trigger a integration or implementation application that is deployed locally within the cloud or desktop IDE:

* <<terminal>>
* <<browser>>
* <<rest-client>>

[[terminal]]
=== Trigger a Flow from the Terminal

Use the Terminal in Anypoint Code Builder to trigger a flow through an HTTP Listener in an integration or implementation project. This procedure works in desktop and cloud IDEs. 


//first generic steps
include::anypoint-code-builder::partial$acb-reusable-steps.adoc[tags="check-connection-http"]
include::anypoint-code-builder::partial$acb-reusable-steps.adoc[tags="open-run-debug"]
include::anypoint-code-builder::partial$acb-reusable-steps.adoc[tags="deploy-locally"]
//open terminal
include::anypoint-code-builder::partial$acb-reusable-steps.adoc[tag="open-terminal"]
. In the terminal, click the name of the shell to use in the terminal, such as PowerShell (for Windows), Bash (`bash`), or Z shell (`zsh` for Mac).
+
Alternatively, you can click the *+* icon in the terminal to open a new command prompt.
. At the command prompt, provide a `curl` command to trigger the flow, for example:
+
* For triggering an integration app from a listener:
+
----
$ curl localhost:8081/mypath
----
+
In the desktop IDE, use `localhost` instead of `0.0.0.0`. 
+
If successful, the command returns a response.
//TODO: TEST/DOUBLE CHECK THIS ONE!
* For triggering a flow in an app from the listener in the scaffolded interface:
+
----
$ curl localhost:8081/api/mypath
----

[[browser]]
=== Trigger a Flow from Your Browser

Use your browser to trigger a flow through an HTTP Listener in an integration or implementation project.

//first generic steps
include::anypoint-code-builder::partial$acb-reusable-steps.adoc[tags="check-connection-http"]
include::anypoint-code-builder::partial$acb-reusable-steps.adoc[tags="open-run-debug"]
include::anypoint-code-builder::partial$acb-reusable-steps.adoc[tags="deploy-locally"]
//open output panel
include::anypoint-code-builder::partial$acb-reusable-steps.adoc[tags="open-output-panel"]

* From the desktop IDE, use `localhost` for `host="0.0.0.0"` and the configured `port` number and `path` values, for example:
+
[source,url]
----
http://localhost:8081/mypath
----
+
If you are triggering a flow from a scaffolded interface, add `api/` to the path so that your request reaches the router, for example:
+
[source,url]
----
http://localhost:8081/api/mypath
----

* From the cloud IDE, find and copy the URL to your app:
+
image::acb-port-list.png["Port list in the IDE"]

.. Click the *Ports* tab to open a list of ports used by your app.
.. Select the row for the port you configured for the HTTP Listener, such as `8081`. 
.. From the *Forwarded Address* column, copy the URL at the selected port. 
. Copy the URL into your browser, _and_ append the value of the `path` from your `<http:listener/>` configuration.
+
For example, the value of `path` is `mypath` in this configuration:
+
[source,xml]
----
<http:listener path="mypath" config-ref="HTTP_Listener_config"
      doc:name="Listener" doc:id="ehdpqp" />
---- 
+
A full URL with the path `mypath` is similar to this one:
+
[source,url]
----
https://lavender-abc1d2.efg.007.ap-code-builder.platform.salesforce.com/proxy/8081/mypath
----
+
If you are triggering a flow from a scaffolded interface, add `api/` to the path so that your request reaches the router, for example:
+
[source,url]
----
https://lavender-abc1d2.efg.007.ap-code-builder.platform.salesforce.com/proxy/8081/api/mypath
----

[[rest-client]]
=== Trigger a Flow from Your REST Client

Use a REST client to trigger a flow through an HTTP Listener in an integration or implementation project. 

This process is simpler for the desktop IDE than the cloud IDE, which requires you to discover the `proxysession` value from the cookies listed in your browser and providing that value to the REST client. 

//first generic steps
include::anypoint-code-builder::partial$acb-reusable-steps.adoc[tags="check-connection-http"]
include::anypoint-code-builder::partial$acb-reusable-steps.adoc[tags="open-run-debug"]
include::anypoint-code-builder::partial$acb-reusable-steps.adoc[tags="deploy-locally"] 
+
This example in Advanced REST Client applies the `proxysession` setting as a cookie within the header of the request. The URL to the application is in the GET field. 

image::acb-proxysession-trigger-flow.png["Finding proxysession cookie in your browser"]


////
[[ping-browser]]
== Trigger a Locally Deployed Application on the Cloud IDE Using a Browser

. Open the Mule project that you want to test and navigate to *Run* > *Start Debugging* (`F5`).
. After your application deploys successfully, open a new tab in your browser.
. Type the URL of your cloud IDE instance, add the `/proxy/` path, and then add the port number you configured as a new path:
`+https://<web-IDE-instance>/api/<port-you-configured-on-your-listener>/+`
+
For example:
+
[source]
--
https://lavender-ndm0yl.builder.code.com/proxy/8081/
--
+
See xref:manage-web-ide-instance.adoc[] to ensure that you are using the correct instance URL.
. When pinging that URL, the cloud IDE triggers the Mule flow.

==================
. Open the cloud IDE using your browser's Developer Tools (`F12`).
. Navigate to your *Application* tab.
. Under *Storage*, expand the *Cookies* section and select the URL of your cloud IDE instance.
. Search for the term _c_:
+
image::application-storage-cookies.png[]
. Copy the cookie name and value. For example:
+
[source]
--
proxysession5f5648c7115f4e2e8f3f9396355ac4e8-0=xxxxxxxxxxxxxx
--
+
[NOTE]
--
The `proxysession` cookie name varies depending on the user.
--
. In the cloud IDE, open the Mule project that you want to test and navigate to *Run* > *Start Debugging* (`F5`).
. After your application deploys successfully, open your preferred REST client application.
. Type the URL of your cloud IDE instance in the request URL section, add the `/proxy/` path, and then add the port number you configured as a new path:
`+https://<web-IDE-instance>/api/<port-you-configured-on-your-listener>/+`
+
For example:
+
[source]
--
https://lavender-ndm0yl.builder.code.com/proxy/8081/
--
+
See xref:manage-web-ide-instance.adoc[] to ensure that you are using the correct instance URL.
. Configure the headers to send the necessary cookies that you copied earlier:
+
image::send-request-with-cookies.png[]
. When pinging that URL, the cloud IDE triggers the Mule flow.
////
