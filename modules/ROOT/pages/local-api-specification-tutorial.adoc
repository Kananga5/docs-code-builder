= Iteratively Designing and Implementing an API Specification
:page-aliases: implement-a-local-api-guide.adoc, tut-local-iterative-design-implement.adoc
:imagesdir: ../assets/images

include::reuse::partial$beta-banner.adoc[tag="anypoint-code-builder"]

//LOGO (web, desktop, or both)
include::partial$acb-ide-logos.adoc[tags="both-ides"]

Scaffold and synchronize changes to an API specification with an interface file for an existing Mule project without first publishing the specification to Anypoint Exchange. The interface is a configuration XML file automatically created during the scaffolding process.

For example, if you add a new endpoint to your API specification and run the command `MuleSoft: Implement this local API` from a Mule project, Anypoint Code Builder adds or updates a flow for that endpoint into the interface file. 

Iterative API design and implementation within the IDE takes place in a _multi-root workspace_ in VS Code. The IDE permits only one pair of iterative design and implementation projects per multi-root workspace. 

TIP: Close a multi-root workspace with the command `Workspaces: Close Workspace`. Then you can reopen a synchronized project from the workspace that you create when implementing the API.

== Before You Begin

Follow procedures in xref:setup.adoc[Set Up and Access Anypoint Code Builder].

[[create]]
== Create an API Specification in a New VS Code Window

To avoid potential issues from limitations of multi-root workspaces when implementing a local API specification, start with a new VS Code window and folder for your API specification project:

. Open a new window in VS Code by pressing Cmd+Shift+n (Mac) or Ctrl+Shift+n (Windows).
+
This step helps prevent the possibility of creating an API specification in a multi-root workspace that already contains iterative design and implementation projects and ensures that the command required in the next procedure, <<scaffold>>, is available.
. Open Anypoint Code Builder by clicking the *Anypoint Code Builder* (Mulesoft) icon in the activity bar. 
. Start an API specification by clicking the quick action *Design an API*. 
+
Alternatively, open the Command Palette by pressing Ctrl+Shift+p (Mac) or Cmd+Shift+p (Windows), and provide this command:
+
[source,command]
----
MuleSoft: Design an API
----
. If prompted, sign in to Anypoint Platform. 
. Configure your API using these values:
+
image::design-api-ui-first.png[]
+
--
[calloutlist]
.. In *Project name*, type: `*Retrieve Users API*`.
.. In *Project Location*, select *Browse*, and create a _parent folder_ for your project and select that location. For example:
+
`/Users/me/my-iterative-project-folder`
+
To avoid potential issues related to multi-root workspaces, do not use a pre-existing project folder for iterative design and implementation projects.
.. In *API Specification Language*, select *RAML 1.0*.
.. In *Business Group*, select the business group in which you want to create your API specification. You can't change business groups after you create your API specification.
--
. Select *Create Project*.
+
This process creates a child folder that contains your API specification.
. Navigate to your API specification, and open the specification file:
.. Press Ctrl+Shift+p (Mac) or Cmd+Shift+p (Windows), and provide the following command:
+
[source,command]
----
File: Open Folder
----
.. Navigate to the root directory of the folder that contains your API specification. 
.. In the Explorer, click the filename for the specification, `retrieve-users-api.raml`.
. In the editor, add this example:
+
[source,raml,linenums]
--
#%RAML 1.0
title: Retrieve User
version: 1.0.development
/users:
  get:
    description: Retrieve a list of all the users
    responses:
      200:
        body:
          application/json:
            example: |
              [{
              "id": 1,
              "name": "Leanne Graham",
              "username": "Bret",
              "email": "Sincere@april.biz",
              "address": {
                "street": "Kulas Light",
                "suite": "Apt. 556",
                "city": "Gwenborough",
                "zipcode": "92998-3874",
                "geo": {
                  "lat": "-37.3159",
                  "lng": "81.1496"
                }
              },
              "phone": "1-770-736-8031 x56442",
              "website": "hildegard.org",
              "company": {
                "name": "Romaguera-Crona",
                "catchPhrase": "Multi-layered client-server neural-net",
                "bs": "harness real-time e-markets"
              } }]
--
. Proceed to <<scaffold>>.

[[scaffold]]
== Scaffold the Local API Specification into an Interface

Scaffold your local API specification into a local implementation project. The scaffolding process creates a configuration XML in a 

Local projects reside in the Anypoint Code Builder IDE, whether the projects are in your desktop IDE or in the web IDE associated with your user account in Anypoint Platform. 

Scaffold your local API specification:

. With `retrieve-users-api.raml` open in your IDE, scaffold the specification into a Mule project:
 
.. Find and click the X-shaped *Implement this local API* icon for the specification file. 
+
[[icon-implement-this-api]]
image::tut-local-spec-implement.png["UI with the X-shaped icon for the command Implement this Local API"]
+
Alternatively, open the Command Palette by pressing Ctrl+Shift+p (Windows) or Cmd+Shift+p (Mac), and provide this command:
+
[source,command]
----
MuleSoft: Implement this Local API
----
+
_Do not select_ the command `MuleSoft: Implement an API Specification`, which is for implementing a specification that is published on Anypoint Exchange and _not for_ implementing a local API specification. 
+
The UI displays the following message: *We'll create a workspace to keep your API specification and Mule project in sync.*
+
If you don't find the icon or command, go to <<display-command>>.  
.. Choose a folder for your workspace, such as the _parent folder_ that contains your API specification project folder. _Do not_ select a folder within your API specification directory.
+
A multi-root workspace uses a `.code-workspace` file extension. 
.. After waiting for up to a minute for the field *Mule project name* to appear in the UI, start the scaffolding process by entering a name for your Mule project. 
+
The UI provides updates while the scaffolding process takes place:

... *Implementing local API Implementation, please wait*
... *Scaffolding process ended. You can now start iterating over your local API and implementation project*
. For from your multi-root workspace in the Explorer, open the configuration XML for the new Mule project with the scaffolded specification.
+
* The UI canvas for this Mule project contains a Router component and several error handlers. APIkit automatically creates these components during the scaffolding process.
* The `<flow/>` element contains an `<ee:transform/>` element with your example:
+
[source,XML,linenums]
--
<flow name="get:\users:retrieve-users-api-config">
    <ee:transform doc:name="Transform Message">
        <ee:message>
            <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
[
{
id: 1,
name: "Leanne Graham",
username: "Bret",
email: "Sincere@april.biz",
address: {
  street: "Kulas Light",
  suite: "Apt. 556",
  city: "Gwenborough",
  zipcode: "92998-3874",
  geo: {
    lat: "-37.3159",
    lng: "81.1496"
  }
},
phone: "1-770-736-8031 x56442",
website: "hildegard.org",
company: {
  name: "Romaguera-Crona",
  catchPhrase: "Multi-layered client-server neural-net",
  bs: "harness real-time e-markets"
}
}
]]]></ee:set-payload>
        </ee:message>
    </ee:transform>
</flow>
--
. Proceed to <<update-api-spec>>.

[[update-api-spec]]
== Update the API Specification and Re-scaffold the Implementation XML

Add an endpoint to your specification file and re-scaffold:

. Navigate to the `retrieve-users-api.raml` file within the *Retrieve Users API* directory.
. Add a new `/userbyid` endpoint to your RAML file:
+
[source,raml,linenums]
--
#%RAML 1.0
title: Retrieve User
version: 1.0.development
/users:
  get:
    description: Retrieve a list of all the users
    responses:
      200:
        body:
          application/json:
            example: |
              [{
              "id": 1,
              "name": "Leanne Graham",
              "username": "Bret",
              "email": "Sincere@april.biz",
              "address": {
                "street": "Kulas Light",
                "suite": "Apt. 556",
                "city": "Gwenborough",
                "zipcode": "92998-3874",
                "geo": {
                  "lat": "-37.3159",
                  "lng": "81.1496"
                }
              },
              "phone": "1-770-736-8031 x56442",
              "website": "hildegard.org",
              "company": {
                "name": "Romaguera-Crona",
                "catchPhrase": "Multi-layered client-server neural-net",
                "bs": "harness real-time e-markets"
              } }]
  /userbyid:
    get:
      description: Get information about a particular user
      queryParameters:
        id:
          description: Specify the id of the user you want to retrieve
          type:        integer
          required:    false
          example: 3
      responses:
        200:
          body:
            application/json:
              example: |
                [{
                "id": 3,
                "name": "Clementine Bauch",
                "username": "Samantha",
                "email": "Nathan@yesenia.net",
                "address": {
                  "street": "Douglas Extension",
                  "suite": "Suite 847",
                  "city": "McKenziehaven",
                  "zipcode": "59590-4157",
                  "geo": {
                    "lat": "-68.6102",
                    "lng": "-47.0653"
                  }
                },
                "phone": "1-463-123-4447",
                "website": "ramiro.info",
                "company": {
                  "name": "Romaguera-Jacobson",
                  "catchPhrase": "Face to face bifurcated interface",
                  "bs": "e-enable strategic applications"
                } }]
--
. Re-scaffold the API specification to update your Mule project:

.. Open the Command Palette by pressing Ctrl+Shift+p (Windows) or Cmd+Shift+p (Mac), and provide the following command:
+
[source,command]
----
MuleSoft: Re-scaffold this local API
----
.. After receiving a message that your project *has been rescaffolded successfully*, navigate to your configuration XML, and notice the new flow for the `userbyid` endpoint:
+
[source,XML,linenums]
--
...

<flow name="get:\users\userbyid:retrieve-users-api-config">
    <ee:transform doc:name="Transform Message">
        <ee:message>
            <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
[
{
id: 3,
name: "Clementine Bauch",
username: "Samantha",
email: "Nathan@yesenia.net",
address: {
  street: "Douglas Extension",
  suite: "Suite 847",
  city: "McKenziehaven",
  zipcode: "59590-4157",
  geo: {
    lat: "-68.6102",
    lng: "-47.0653"
  }
},
phone: "1-463-123-4447",
website: "ramiro.info",
company: {
  name: "Romaguera-Jacobson",
  catchPhrase: "Face to face bifurcated interface",
  bs: "e-enable strategic applications"
}
}
]]]></ee:set-payload>
        </ee:message>
    </ee:transform>
</flow>
--
. To save your specification to the SCM in Design Center, go to <<save-spec>>.

[[save-spec]]
== Save your API Specification in Design Center

After implementing your API specification, save the specification to Design Center:

. In Anypoint Code Builder, select the *SOURCE CONTROL* view of the IDE:

* In the desktop IDE, navigate to *View* > *Source Control*.
* In the web IDE, navigate to file menu > *View* > *Source Control*.
. Locate the API specification project for `retrieve-users-api.raml`.
. In the *SOURCE CONTROL* view, click the *+* icon beside your API specification project file to stage your changes. 
. Type a commit message that summarizes the changes. For example: `_Create Retrieve Users API_`
+
This step avoids the need to specify a commit message through a separate file that pops up in the IDE.
. Click *Commit* for the staged changes, and wait for the commit process to complete. 
. If prompted, click *Sync Changes* or *Push*. 
//TODO: OMG, different options every time... :(
+
Your changes are now stored in the Design Center SCM.
. Proceed to <<publish>>.

[[publish]]
== Publish the API Specification to Exchange

You can now publish your new API specification to Exchange to make it discoverable to other team members.

. Open the Command Palette by pressing Ctrl+Shift+p (Windows) or Cmd+Shift+p (Mac), and provide the following command:
+
[source,command]
----
MuleSoft: Publish API Specification to Exchange
----
. Type a project name: *Retrieve Users API*
. Confirm the artifact ID: *Retrieve-Users-API*
. Confirm the asset version: *1.0.0*.
. Confirm the API version: *v1*.
+
The status bar displays the progress, first *Publishing API Specification to Exchange* and when done, a message that the project *has been successfully published to Exchange*. Then the IDE updates your Mule project POM file to point to `v1.0.0` of your API specification.
+
. To work iteratively on a new version of your API specification, close the current workspace and re-import version 1.0.0 of your API from Design Center, and implement it locally again.

[[display-command]]
== Display the Command MuleSoft: Implement this Local API

If `MuleSoft: Implement this Local API Command` does not appear in the command palette from your open API specification project, it is likely that another project in your multi-root workspace is implementing a local API specification. 

. In the Explorer, right-click your new API specification folder, select *Remove project from workspace*.
. Open a new VS Code window by pressing Ctrl+Shift+n (Mac) or Cmd+Shift+n (Windows).
. In the new window, navigate to the API specification, and open the specification file:
.. Press Ctrl+Shift+p (Mac) or Cmd+Shift+p (Windows), and provide the following command:
+
[source,command]
----
File: Open Folder
----
.. Navigate to the root directory of the folder that contains your API specification. 
.. In the Explorer, click the filename for the specification, `retrieve-users-api.raml`.
. Wait for the <<icon-implement-this-api, X-shaped icon> for the `MuleSoft: Implement this API` command to appear in the UI. 
+
To monitor the status of this process, open the *OUTPUT* panel with Ctrl+Shift+u (Windows) or Cmd+Shift+u (Mac) and selecting *MS DX Server* from it drop-down menu. 
. Proceed to <<scaffold>> to start the implementation process.