= Iteratively Designing and Implementing an API Specification
:page-aliases: implement-a-local-api-guide.adoc, tut-local-iterative-design-implement.adoc
:imagesdir: ../assets/images

include::reuse::partial$beta-banner.adoc[tag="anypoint-code-builder"]

//LOGO (web, desktop, or both)
include::partial$acb-ide-logos.adoc[tags="both-ides"]

Anypoint Code Builder enables you to scaffold an API specification into the configuration XML for Mule project without first publishing the specification to Anypoint Exchange. For example, if you add a new endpoint to your API specification, Anypoint Code Builder is able to scaffold a new flow for that endpoint through the command `MuleSoft: Implement this local API`.

////
TODO duke: TBD: INTEGRATE THIS INFO? 
Implementing a local API enables you to reflect your changes to your API design directly into the Mule project that implements your API specification.

You can close your multi-root workspace by running the Workspaces: Close Worspace command. You can re-open your synchronized project by opening the workspace your created when you started implementing your local API.
////

== Before You Begin

Set up your MuleSoft environment. See xref:setup.adoc[] for more information. 

== Create an API Specification in a New VS Code Window

[[avoid-issue]]
//anchor for link from first step to this intro
Iterative API design and implementation within the IDE takes place in a multi-root workspace in VS Code. However, the IDE permits only one iterative design and implementation project per multi-root workspace, and any API specification created from a VS Code window associated with a multi-root workspace automatically belongs to that workspace. To avoid potential issues from limitations of multi-root workspaces, the first step of this procedure starts from a new VS Code window.

To create a new API specification:

. Open a new window in VS Code by pressing Ctrl+Shift+n (Mac) or Cmd+Shift+n (Windows).
+
This step prevents the possibility of creating an API specification in a multi-root workspace that already contains iterative design and implementation projects and ensures that the command required in the next procedure, <<implement-local>>, is available.
. Open the Command Palette by pressing Ctrl+Shift+p (Mac) or Cmd+Shift+p (Windows), and provide the following command:
+
[source,command]
----
MuleSoft: Design an API
----
. Configure your API using the following values:
+
image::design-api-ui-first.png[]
+
[calloutlist]
.. In *Project name*, type: `*Retrieve Users API*`.
.. In *Project Location*, select *Browse* and then select your home directory.
.. In *API Specification Language*, select *RAML 1.0*.
.. In *Business Group*, select the business group in which you want to create your API specification.
+
[IMPORTANT]
--
You can't change business groups after you create your API specification.
--
. Select *Create Project*.
+
The Explorer displays your *Retrieve Users API* folder with a `retrieve-users-api.raml` file open in the editor.
+
If you receive the error `Unexpected error occurred opening the API Specification`, navigate to your project folder and open the specification file:

.. Press Ctrl+Shift+p (Mac) or Cmd+Shift+p (Windows), and provide the following command:
+
[source,command]
----
File: Open Folder
----
.. Navigate to the root directory for the project that contains your API specification. 
.. In the Explorer, click the filename for the specification, `retrieve-users-api.raml`.
// REUSE
. In the editor, add the following RAML specification for an example:
+
[source,raml,linenums]
--
#%RAML 1.0
title: Retrieve User
version: 1.0.development
/users:
  get:
    description: Retrieve a list of all the users
    responses:
      200:
        body:
          application/json:
            example: |
              [{
              "id": 1,
              "name": "Leanne Graham",
              "username": "Bret",
              "email": "Sincere@april.biz",
              "address": {
                "street": "Kulas Light",
                "suite": "Apt. 556",
                "city": "Gwenborough",
                "zipcode": "92998-3874",
                "geo": {
                  "lat": "-37.3159",
                  "lng": "81.1496"
                }
              },
              "phone": "1-770-736-8031 x56442",
              "website": "hildegard.org",
              "company": {
                "name": "Romaguera-Crona",
                "catchPhrase": "Multi-layered client-server neural-net",
                "bs": "harness real-time e-markets"
              } }]
--

[[implement-local]]
== Implement the Local API Specification in a Multi-Root Workspace

Synchronizing your local API specification with a local implementation project in your IDE requires a multi-root workspace in Visual Studio Code. A local project for a specification or implementation resides in your Anypoint Code Builder IDE, whether in your desktop IDE or in the web IDE associated with your user account in Anypoint Platform. 

To implement your specification in a multi-root workspace:

. Open the Command Palette by pressing Ctrl+Shift+p (Windows) or Cmd+Shift+p (Mac), and provide the following command:
+
[source,command]
----
MuleSoft: Implement this Local API
----
+
The UI displays the following message: *We'll create a workspace to keep your API specification and Mule project in sync.*
//+
//TODO: If you do not find this command in the command palette, go to <<fix-project>>.
. Code Builder creates a multi-root workspace to keep your API specification and Mule project in sync.
.. Choose a folder for your workspace, such as the _parent folder_ that contains your API specification project folder. _Do not_ select a folder within your API specification directory.
+
A multi-root workspace uses a `.code-workspace` file extension.
+ 
The UI displays the message *Implementing local API Implementation, please wait*. . Wait for the field *Mule project name* to appear in the UI, and provide a name for your Mule project when the field is present.
. Use *Select a target folder* for your workspace. 
+
Anypoint Code Builder builds your implementation project. 
. 
+
In this step, Code Builder packages the API specification and publishes it to a local Maven repository as a snapshot.
////
[TIP]
--
To monitor the progress of this task:

. Open the output panel by pressing Ctrl+Shift+u (Windows) or Cmd+Shift+u (Mac)
. From the output panel, select *Mule DX Server* from the drop-down menu.
+
image::select-mule-dx-server.png[]
--
////
. After building your API, Code Builder can now implement it locally:
.. Choose a project name for your Mule project: `_Retrieve Users Implementation_`.
.. Select your home directory as your target folder.


After Code Builder scaffolds your API specification, it opens a new directory in your newly created multi-root workspace with a Mule project. Note that it creates a flow with the proper APIkit router and another flow for the `GET` resource you designed in the RAML file:

[source,XML,linenums]
--
<flow name="get:\users:retrieve-users-api-config">
    <ee:transform doc:name="Transform Message">
        <ee:message>
            <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
[
{
id: 1,
name: "Leanne Graham",
username: "Bret",
email: "Sincere@april.biz",
address: {
  street: "Kulas Light",
  suite: "Apt. 556",
  city: "Gwenborough",
  zipcode: "92998-3874",
  geo: {
    lat: "-37.3159",
    lng: "81.1496"
  }
},
phone: "1-770-736-8031 x56442",
website: "hildegard.org",
company: {
  name: "Romaguera-Crona",
  catchPhrase: "Multi-layered client-server neural-net",
  bs: "harness real-time e-markets"
}
}
]]]></ee:set-payload>
        </ee:message>
    </ee:transform>
</flow>
--

== Update the API Specification

. Navigate back to the `retrieve-users-api.raml` file under the *Retrieve Users API* directory.
+
[TIP]
--
To get a full picture of your API you can arrange the tabs to have the RAML editor, the XML configuration file editor, and the canvas one next to the other.
--
. Add a new `/userbyid` endpoint to your RAML file:
+
[source,raml,linenums]
--
#%RAML 1.0
title: Retrieve User
version: 1.0.development
/users:
  get:
    description: Retrieve a list of all the users
    responses:
      200:
        body:
          application/json:
            example: |
              [{
              "id": 1,
              "name": "Leanne Graham",
              "username": "Bret",
              "email": "Sincere@april.biz",
              "address": {
                "street": "Kulas Light",
                "suite": "Apt. 556",
                "city": "Gwenborough",
                "zipcode": "92998-3874",
                "geo": {
                  "lat": "-37.3159",
                  "lng": "81.1496"
                }
              },
              "phone": "1-770-736-8031 x56442",
              "website": "hildegard.org",
              "company": {
                "name": "Romaguera-Crona",
                "catchPhrase": "Multi-layered client-server neural-net",
                "bs": "harness real-time e-markets"
              } }]
  /userbyid:
    get:
      description: Get information about a particular user
      queryParameters:
        id:
          description: Specify the id of the user you want to retrieve
          type:        integer
          required:    false
          example: 3
      responses:
        200:
          body:
            application/json:
              example: |
                [{
                "id": 3,
                "name": "Clementine Bauch",
                "username": "Samantha",
                "email": "Nathan@yesenia.net",
                "address": {
                  "street": "Douglas Extension",
                  "suite": "Suite 847",
                  "city": "McKenziehaven",
                  "zipcode": "59590-4157",
                  "geo": {
                    "lat": "-68.6102",
                    "lng": "-47.0653"
                  }
                },
                "phone": "1-463-123-4447",
                "website": "ramiro.info",
                "company": {
                  "name": "Romaguera-Jacobson",
                  "catchPhrase": "Face to face bifurcated interface",
                  "bs": "e-enable strategic applications"
                } }]
--

== Re-Scaffold the API Specification

With a new endpoint added to your API specification, you can now re-scaffold it to update your linked Mule project:

. Ensure that the `retrieve-users-api.raml` file is still active in the RAML editor.
. Open the Command Palette by pressing Ctrl+Shift+p (Windows) or Cmd+Shift+p (Mac), and provide the following command:
+
[source,command]
----
MuleSoft: Implement this local API
----
. Select the command.
+
Note that Code Builder adds a new flow for the newly added endpoint:
+
[source,XML,linenums]
--
<flow name="get:\users:retrieve-users-api-config">
    <ee:transform doc:name="Transform Message">
        <ee:message>
            <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
[
{
id: 1,
name: "Leanne Graham",
username: "Bret",
email: "Sincere@april.biz",
address: {
  street: "Kulas Light",
  suite: "Apt. 556",
  city: "Gwenborough",
  zipcode: "92998-3874",
  geo: {
    lat: "-37.3159",
    lng: "81.1496"
  }
},
phone: "1-770-736-8031 x56442",
website: "hildegard.org",
company: {
  name: "Romaguera-Crona",
  catchPhrase: "Multi-layered client-server neural-net",
  bs: "harness real-time e-markets"
}
}
]]]></ee:set-payload>
        </ee:message>
    </ee:transform>
</flow>

<flow name="get:\users\userbyid:retrieve-users-api-config">
    <ee:transform doc:name="Transform Message">
        <ee:message>
            <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
[
{
id: 3,
name: "Clementine Bauch",
username: "Samantha",
email: "Nathan@yesenia.net",
address: {
  street: "Douglas Extension",
  suite: "Suite 847",
  city: "McKenziehaven",
  zipcode: "59590-4157",
  geo: {
    lat: "-68.6102",
    lng: "-47.0653"
  }
},
phone: "1-463-123-4447",
website: "ramiro.info",
company: {
  name: "Romaguera-Jacobson",
  catchPhrase: "Face to face bifurcated interface",
  bs: "e-enable strategic applications"
}
}
]]]></ee:set-payload>
        </ee:message>
    </ee:transform>
</flow>
--

== Save your API Specification in Design Center

With your changes implemented, you can now save your API specification to Design Center:

. In Anypoint Code Builder, select your Source Control view.
. Select the plus icon next to `retrieve-users-api.raml`.
. Review the changes in the Source Control view. Note that the file has moved into *Staged Changes*.
. Stage the remaining changes. 
. Enter a message that summarizes the change or changes being made. For example: `_Create Retrieve Users API_`.
// TODO: cc: On Desktop I had to push the "Commit" button here. Is this the same for Web? And then instead of "Push", it was "Sync Changes." Does this also differ from Web?
. Select *Push*.

Your changes are now published in Design Center.


== Publish the API Specification to Exchange

You can now publish your new API specification to Exchange to make it discoverable to other team members.

. Open the Command Palette by pressing Ctrl+Shift+p (Windows) or Cmd+Shift+p (Mac), and provide the following command:
+
[source,command]
----
MuleSoft: Publish API Specification to Exchange
----
. Type a project name: +
* *Retrieve Users API*.
. Confirm the artifact ID: *Retrieve-Users-API*
. Confirm the asset version: *1.0.0*.
. Confirm the API version: *v1*.
+
The status bar shows the progress.

After the deployment completes, Code Builder updates your Mule project pom file to point to `v1.0.0` of your API specification.

To work iteratively on a new version of your API specification, close the current workspace and re-import version 1.0.0 of your API from Design Center, and implement it locally again.


////
NOT WORKING, IN PROGRESS
== Display MuleSoft: Implement this Local API Command

If `MuleSoft: Implement this Local API Command` does not appear in the command palette from your open API specification project, it is likely that another set of iterative projects is in your multi-root workspace. 

To address this issue:

. In the Explorer, right-click your new API specification folder, and select *Remove project from workspace*. 
. Select or create a folder for the workspace.
+
This step opens to the  
. Reopen your API specification by pressing Ctrl+Shift+p (Mac) or Cmd+Shift+p (Windows), and provide the following command:
+
[source,command]
----
File: Open Folder
---- 
. Find and open the folder with you the new API specification. 
. Select a  workspace

////
